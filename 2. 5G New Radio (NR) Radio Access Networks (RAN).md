
- 5G supports **VoNR** (Voice over New Radio) and **ViNR** (Video over New Radio).

### RAN (Radio Access Network) Protocol Stack:

![userplane/controlprotocols](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch1/Screenshot%202024-10-15%20205053.png)

#### User Plane Protocol Stack:
All the protocols in this stack utilize the services of the protocol below them. The **UE (User Equipment) protocol** communicates with the **gNodeB protocols** to establish and maintain the connection.

- **PHY (Physical Layer)**: 
  - Responsible for efficient wireless communication.

- **MAC (Medium Access Control Layer)**: 
  - Functions include retransmission, multiplexing/demultiplexing, and scheduling.

- **RLC (Radio Link Control Layer)**: 
  - Implements **ARQ (Automatic Repeat Request)** for error correction.
  - Handles segmentation, breaking up data packets into smaller segments.

- **PDCP (Packet Data Convergence Protocol)**: 
  - Responsible for header control, ciphering, and integrity protection.
  - Performs duplicate removal.

- **SDAP (Service Data Adaptation Protocol)**: 
  - Matches the appropriate QoS bearer to the correct radio bearer.
  - For example, a voice call packet is treated differently from a streaming packet.

The input of each protocol layer is the output of the layer above it.

### Packet Flow Through 5G Protocol Layers

![sdu/pdu](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch2/Screenshot%202024-10-14%20120121.png)

### SDU and PDU:
- **SDU (Service Data Unit)**: Data received from the layer above.
- **PDU (Protocol Data Unit)**: Processed data with added headers, passed to the next layer.



![packetflow](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch2/Screenshot%202024-10-15%20211037.png)

1. **SDAP (Service Data Adaptation Protocol)**
   - Maps the **SDU** to the correct QoS bearer.
   - Outputs a **PDU** passed to the **PDCP** layer.

2. **PDCP (Packet Data Convergence Protocol)**
   - Handles header compression, encryption, and integrity protection.
   - Processes the **SDU** and generates a **PDU** for **RLC**.

3. **RLC (Radio Link Control Layer)**
   - Segments or concatenates the data.
   - Performs error correction using **ARQ**.
   - Produces a **PDU** for the **MAC** layer.

4. **MAC (Medium Access Control Layer)**
   - Handles multiplexing, scheduling, and retransmissions.
   - Organizes data into transport blocks (its **PDU**) and sends them to **PHY**.

5. **PHY (Physical Layer)**
   - Converts the **MAC PDU** into radio signals for transmission over the air.
## Control Plane Layer

![controlplanenas](https://github.com/user-attachments/assets/628d8811-4314-4fa5-ac06-9698fe0f5801)
![rrc](https://github.com/user-attachments/assets/0aa1bcbf-fe06-4b66-9f7f-fccb7873608f)

***SDAP***
Looking at the sdap layer in more detail,

![differenttraffic](https://github.com/user-attachments/assets/b10859f1-3b29-4c1c-866c-57c10891e515)

To manage all these types of traffic the sdap separates them into different QoS flows.

![qosflows](https://github.com/user-attachments/assets/3ba9a9d9-6a6c-4246-bae0-c01c4ad2b617)

There are different types of QoS flows

![gbr/ngbr](https://github.com/user-attachments/assets/8d072547-644a-4067-9a47-f76a71263325)

Guaranteed Bit Rate(GBR) -->for critical functions or voice calls.
and Non-Guaranteed Bit Rate(NGBR) --> for streaming or normal broadband connection where steady connection is not required.

![iptoQosflow](https://github.com/user-attachments/assets/23654246-b0ca-4c7f-a79a-177d33309594)

Multiplexing occurs at two points in the 5G ran system. The sdap converts IP packets to QoS flows at the core network as per requirement and The upf converts IP flow to QoS flows at the core network.
The SDAP maps each flow into radio bearers. The following example helps in understanding this.

![examplesdap](https://github.com/user-attachments/assets/c9e4bcf2-6857-4439-a03f-780cf93644e7)

***PDCP***

The PDCP does 4 tasks,
Firstly it compresses the headers which are 40 bytes in IPv4 and 60 in IPv6 which is almost as large as some smaller data packets, it follows the ROHC(Robust Header Compression).

![Headercompression](https://github.com/user-attachments/assets/a49cb0c2-16d6-41c4-9df3-5311375b818f)

 Ciphering and Integrity protection: Encrypts data and ensures data integrity for secure communication.

 **KRRC,ENC (Key for RRC Encryption)**: 
   - Used by pdcp to encrypt RRC (Radio Resource Control) messages, ensuring the confidentiality of control signaling between the UE and gNodeB.
 **KRRC,INT (Key for RRC Integrity Protection)**: 
   - Employed by pdcp to provide integrity protection for RRC messages, ensuring that control signaling is not altered or tampered with during transmission.
     
![encrytp&integrity](https://github.com/user-attachments/assets/821fc749-f43a-4ca8-ae1b-0caf99806923)


 Routing and Duplication: Sends data through two streams to achieve high reliabilty(one data gets lost other will still deliver) and higher data rates.

 ![duplication](https://github.com/user-attachments/assets/44a251b9-ae8d-4131-a4f6-7d9b2617651e)

Reordering: Ensures that out-of-order packets are correctly re-sequenced before delivery to higher layers. In-Sequence and Out-of-Sequence deliveries occur, for certain services like video streaming it is nescessary for packets to arrive at destination in order, so the pdcp waits untill all the pdus of previous layer have arrived and are in order before forwarding it to another layer.



![insquence](https://github.com/user-attachments/assets/aa93edbb-ed4e-4bfd-b39e-b443f2cdd003)

the left is for recieving right is for transmission.

![pdcp](https://github.com/user-attachments/assets/a1ae05a6-b130-459d-a336-5f3d208892c8)

***RLC(Radio Link Control)***

There are different modes of RLC for different data types.Some data types may not require some functions of RLC.

![rlcmode](https://github.com/user-attachments/assets/1d91c98e-2346-42f8-b5f4-04899262b2c3)

The header part in the rlc pdu contains some segmentation information, segmentation is the process of division of data packets for ease of transmission. The segmentation informations contains the order in which data packets have been divided which is utilised if they need to be arranged in order again.

![rlcsegment](https://github.com/user-attachments/assets/8e337dac-1fe1-49d4-8ef0-755f2aa7ef19)

Unlike 4G in 5G in sequence delivery is not compulsory and is handled by PDCP instead of RLC, this reduces buffer and delay.

Now we will be going through the process of transmission of data to see why <b>retransmission(ARQ)</b> is important.

![retransmission1](https://github.com/user-attachments/assets/179c2d64-f109-4159-8de3-e8e0895594c5)

When a packet does not arrive the reciever starts a timer until which all incoming packets are stopped.

![retrans2](https://github.com/user-attachments/assets/4a4b6c96-3066-4ae7-bed9-d2f9ad754f11)

In this case, the packet arrives before timer ends so transmission continues.

![retrans3](https://github.com/user-attachments/assets/8b254694-cca9-4aa0-b67a-547cf1388b98)

Now some more packets go missing.

![retrans4](https://github.com/user-attachments/assets/7a20e6a8-6159-4b8e-8da2-19100019a318)
Packets do not arrive before timer ends so reciever sends a control signal back to transmitter to <b>retransmit</b> missing packages.
![retrans5](https://github.com/user-attachments/assets/24cdece2-664a-4efe-be07-09bf9a4a8492)
Packets arrive successfully after transmitter recieves control signal.
![retrans6](https://github.com/user-attachments/assets/a2823b74-f3d9-4c17-a1c6-f35826693b46)

### MAC(Medium Access Control)

Some examples of **mac** channels are listed below

![macchannels](https://github.com/user-attachments/assets/3bef4a4e-7a4c-454b-96c2-0eca864ef9f5)

The MAC pdu consists of data recieved from earlier layers as well as MAC Control Elements(CE), the CE functions are listed below.

![maccontrolelement](https://github.com/user-attachments/assets/797a74e1-5260-4e47-b690-f33eae0be9cd)

The MAC layer is also responsible for distributing the data into different carriers through multiplexing.

![carrierdist](https://github.com/user-attachments/assets/5ce3cf13-843d-42fe-aacf-62ef4a05064f)

Hybrid ARQ(HARQ) is also carried out at this stage, in this process, transmission of several transport blocks happens simultaneously to reduce time consumption.
NR follows asynchronous ARQ process, i.e., the processes are processed dynamically via acknowledgement or non-acknowledgement feedback.

![harq](https://github.com/user-attachments/assets/fcdbc8d8-77d3-42f3-9c0c-37ee4962a352)

Since transport blocks can get quite large we divide it into CBGs (core block groups), so that if any error occurs only the CBG needs to be retransmitted instead of whole transport block.

![cbg](https://github.com/user-attachments/assets/87369edd-85a2-4656-a9fc-660519358ced)

***Scheduler**

The function of a scheduler is to allocate when and how much data is to be allocated to different users sharing the same data channel.

![scheduler](https://github.com/user-attachments/assets/7ecb85ca-0306-4347-a6d0-8cda2c750905)

![image](https://github.com/user-attachments/assets/fda50c58-3447-4366-8869-4ec0799e24b6)





