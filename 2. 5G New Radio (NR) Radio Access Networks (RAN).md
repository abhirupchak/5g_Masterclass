
- 5G supports **VoNR** (Voice over New Radio) and **ViNR** (Video over New Radio).

### RAN (Radio Access Network) Protocol Stack:

![userplane/controlprotocols](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch1/Screenshot%202024-10-15%20205053.png)

#### User Plane Protocol Stack:
All the protocols in this stack utilize the services of the protocol below them. The **UE (User Equipment) protocol** communicates with the **gNodeB protocols** to establish and maintain the connection.

- **PHY (Physical Layer)**: 
  - Responsible for efficient wireless communication.

- **MAC (Medium Access Control Layer)**: 
  - Functions include retransmission, multiplexing/demultiplexing, and scheduling.

- **RLC (Radio Link Control Layer)**: 
  - Implements **ARQ (Automatic Repeat Request)** for error correction.
  - Handles segmentation, breaking up data packets into smaller segments.

- **PDCP (Packet Data Convergence Protocol)**: 
  - Responsible for header control, ciphering, and integrity protection.
  - Performs duplicate removal.

- **SDAP (Service Data Adaptation Protocol)**: 
  - Matches the appropriate QoS bearer to the correct radio bearer.
  - For example, a voice call packet is treated differently from a streaming packet.

The input of each protocol layer is the output of the layer above it.

### Packet Flow Through 5G Protocol Layers

![sdu/pdu](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch2/Screenshot%202024-10-14%20120121.png)

### SDU and PDU:
- **SDU (Service Data Unit)**: Data received from the layer above.
- **PDU (Protocol Data Unit)**: Processed data with added headers, passed to the next layer.



![packetflow](https://github.com/abhirupchak/images-5G_masterclass/blob/main/imagesch2/Screenshot%202024-10-15%20211037.png)

1. **SDAP (Service Data Adaptation Protocol)**
   - Maps the **SDU** to the correct QoS bearer.
   - Outputs a **PDU** passed to the **PDCP** layer.

2. **PDCP (Packet Data Convergence Protocol)**
   - Handles header compression, encryption, and integrity protection.
   - Processes the **SDU** and generates a **PDU** for **RLC**.

3. **RLC (Radio Link Control Layer)**
   - Segments or concatenates the data.
   - Performs error correction using **ARQ**.
   - Produces a **PDU** for the **MAC** layer.

4. **MAC (Medium Access Control Layer)**
   - Handles multiplexing, scheduling, and retransmissions.
   - Organizes data into transport blocks (its **PDU**) and sends them to **PHY**.

5. **PHY (Physical Layer)**
   - Converts the **MAC PDU** into radio signals for transmission over the air.
## Control Plane Layer

![controlplanenas](https://github.com/user-attachments/assets/628d8811-4314-4fa5-ac06-9698fe0f5801)
![rrc](https://github.com/user-attachments/assets/0aa1bcbf-fe06-4b66-9f7f-fccb7873608f)

***SDAP***
Looking at the sdap layer in more detail,

![differenttraffic](https://github.com/user-attachments/assets/b10859f1-3b29-4c1c-866c-57c10891e515)

To manage all these types of traffic the sdap separates them into different QoS flows.

![qosflows](https://github.com/user-attachments/assets/3ba9a9d9-6a6c-4246-bae0-c01c4ad2b617)

There are different types of QoS flows

![gbr/ngbr](https://github.com/user-attachments/assets/8d072547-644a-4067-9a47-f76a71263325)

Guaranteed Bit Rate(GBR) -->for critical functions or voice calls.
and Non-Guaranteed Bit Rate(NGBR) --> for streaming or normal broadband connection where steady connection is not required.

![iptoQosflow](https://github.com/user-attachments/assets/23654246-b0ca-4c7f-a79a-177d33309594)

Multiplexing occurs at two points in the 5G ran system. The sdap converts IP packets to QoS flows at the core network as per requirement and The upf converts IP flow to QoS flows at the core network.
The SDAP maps each flow into radio bearers. The following example helps in understanding this.

![examplesdap](https://github.com/user-attachments/assets/c9e4bcf2-6857-4439-a03f-780cf93644e7)

***PDCP***

The PDCP does 4 tasks,
Firstly it compresses the headers which are 40 bytes in IPv4 and 60 in IPv6 which is almost as large as some smaller data packets, it follows the ROHC(Robust Header Compression).

![Headercompression](https://github.com/user-attachments/assets/a49cb0c2-16d6-41c4-9df3-5311375b818f)

 Ciphering and Integrity protection: Encrypts data and ensures data integrity for secure communication.

 **KRRC,ENC (Key for RRC Encryption)**: 
   - Used by pdcp to encrypt RRC (Radio Resource Control) messages, ensuring the confidentiality of control signaling between the UE and gNodeB.
 **KRRC,INT (Key for RRC Integrity Protection)**: 
   - Employed by pdcp to provide integrity protection for RRC messages, ensuring that control signaling is not altered or tampered with during transmission.
     
![encrytp&integrity](https://github.com/user-attachments/assets/821fc749-f43a-4ca8-ae1b-0caf99806923)


 Routing and Duplication: Sends data through two streams to achieve high reliabilty(one data gets lost other will still deliver) and higher data rates.

 ![duplication](https://github.com/user-attachments/assets/44a251b9-ae8d-4131-a4f6-7d9b2617651e)

Reordering: Ensures that out-of-order packets are correctly re-sequenced before delivery to higher layers. In-Sequence and Out-of-Sequence deliveries occur, for certain services like video streaming it is nescessary for packets to arrive at destination in order, so the pdcp waits untill all the pdus of previous layer have arrived and are in order before forwarding it to another layer.

![insquence](https://github.com/user-attachments/assets/aa93edbb-ed4e-4bfd-b39e-b443f2cdd003)

the left is for recieving right is for transmission.

![pdcp](https://github.com/user-attachments/assets/a1ae05a6-b130-459d-a336-5f3d208892c8)

